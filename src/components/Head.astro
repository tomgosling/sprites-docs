---
import Default from '@astrojs/starlight/components/Head.astro';
import Background from './Background.astro';

const siteUrl = 'https://docs.sprites.dev';
const pageTitle = Astro.locals.starlightRoute?.entry?.data?.title ?? 'Sprites Documentation';
const ogImageUrl = `https://og-images.fly.dev/image?template=sprites&text=${encodeURIComponent(pageTitle)}`;
const slug = Astro.locals.starlightRoute?.slug ?? Astro.locals.starlightRoute?.id;
const isHomePage = slug === '' || slug === 'index' || slug === 'index.mdx';

const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Sprites Documentation',
  url: siteUrl,
};

// Build breadcrumbs from URL path
const formatSegment = (segment: string) =>
  segment
    .split('-')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');

const pathSegments = (slug || '')
  .replace(/\.mdx?$/, '')
  .split('/')
  .filter(Boolean);

const breadcrumbItems = [
  { name: 'Sprites Documentation', url: siteUrl },
  ...pathSegments.slice(0, -1).map((segment, index) => ({
    name: formatSegment(segment),
    url: `${siteUrl}/${pathSegments.slice(0, index + 1).join('/')}/`,
  })),
  ...(pathSegments.length > 0
    ? [{ name: pageTitle, url: `${siteUrl}/${pathSegments.join('/')}/` }]
    : []),
];

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: breadcrumbItems.map((item, index) => ({
    '@type': 'ListItem',
    position: index + 1,
    name: item.name,
    item: item.url,
  })),
};

// API version redirect - check if we need to redirect to stored preference
const currentPath = Astro.url.pathname;
const apiMatch = currentPath.match(/^\/api\/([^/]+)/);
const isApiPage = apiMatch !== null;

// Build version map for the inline script
import { API_VERSIONS, versionToSlug, getVersionFromPath } from '@/lib/api-versions';
const versionMap = Object.fromEntries(
	API_VERSIONS.map(v => [v.id, versionToSlug(v.id)])
);
const currentVersionId = isApiPage ? getVersionFromPath(currentPath) : null;
---

{/* Version redirect script - must run immediately before any content */}
{isApiPage && (
<script is:inline define:vars={{ versionMap, currentVersionId }}>
(function() {
	var STORAGE_KEY = 'sprites-api-version';
	var storedVersion = localStorage.getItem(STORAGE_KEY);
	if (!storedVersion || !currentVersionId || storedVersion === currentVersionId) return;
	var storedSlug = versionMap[storedVersion];
	if (!storedSlug) return;
	var path = window.location.pathname;
	var match = path.match(/^\/api\/[^/]+\/?(.*)$/);
	var page = match ? match[1] : '';
	var newPath = '/api/' + storedSlug + (page ? '/' + page : '/');
	window.location.replace(newPath);
})();
</script>
)}

<Default {...Astro.props}><slot /></Default>
<Background />

<!-- Privacy-friendly analytics by Plausible -->
<script async src="https://plausible.io/js/pa-X9Qgz6h0EcKGLrtNH5b5V.js"></script>
<script>
  window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
  plausible.init()
</script>

<!-- Dynamic OG Image -->
<meta property="og:image" content={ogImageUrl} />
<meta name="twitter:image" content={ogImageUrl} />

{isHomePage && (
  <Fragment set:html={`<script type="application/ld+json">${JSON.stringify(websiteSchema)}</script>`} />
)}

<Fragment set:html={`<script type="application/ld+json">${JSON.stringify(breadcrumbSchema)}</script>`} />

<!-- Custom code block copy button with animated green check -->
<script>
  const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="check-icon"><path d="M5 12l5 5L20 7"/></svg>`;
  const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`;
  const link2Icon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 17H7A5 5 0 0 1 7 7h2"/><path d="M15 7h2a5 5 0 1 1 0 10h-2"/><line x1="8" x2="16" y1="12" y2="12"/></svg>`;

  async function copyWithFeedback(element, text) {
    try {
      await navigator.clipboard.writeText(text);
      element.classList.add('copied');
      setTimeout(() => element.classList.remove('copied'), 2000);
      return true;
    } catch (err) {
      console.error('Failed to copy:', err);
      return false;
    }
  }

  function initCodeBlocks() {
    // Output section styling - merge ```output blocks with preceding code block
    document.querySelectorAll('.expressive-code').forEach((block) => {
      if (block.dataset.outputProcessed) return;
      block.dataset.outputProcessed = 'true';

      // Check if this is an output block (language="output")
      const pre = block.querySelector('pre');
      if (!pre || pre.dataset.language !== 'output') return;

      // Find the preceding code block
      let prevSibling = block.previousElementSibling;
      while (prevSibling && !prevSibling.classList.contains('expressive-code')) {
        prevSibling = prevSibling.previousElementSibling;
      }

      if (!prevSibling) return;

      // Mark this as an output block and hide its frame chrome
      block.classList.add('is-output-block');
      prevSibling.classList.add('has-output-block');
    });

    // Custom copy buttons
    document.querySelectorAll('.expressive-code .copy button').forEach((button) => {
      if (button.dataset.customized) return;
      button.dataset.customized = 'true';

      // ExpressiveCode stores newlines as \u007f (DEL char) in data-code, convert back
      const code = (button.dataset.code || '').replace(/\u007f/g, '\n');

      button.innerHTML = `
        <span class="copy-icon-wrapper">${copyIcon}</span>
        <span class="check-icon-wrapper">${checkIcon}</span>
      `;

      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        copyWithFeedback(button, code);
      }, { capture: true });
    });

    // Anchor link copy
    document.querySelectorAll('.sl-anchor-link').forEach((link) => {
      if (link.dataset.copyInit) return;
      link.dataset.copyInit = 'true';

      const iconSpan = link.querySelector('.sl-anchor-icon');
      if (iconSpan) {
        iconSpan.innerHTML = `
          <span class="link-icon-wrapper">${link2Icon}</span>
          <span class="check-icon-wrapper">${checkIcon}</span>
        `;
      }

      link.addEventListener('click', (e) => {
        e.preventDefault();
        copyWithFeedback(link, link.href);
        // Update URL and scroll to the target section
        const hash = link.getAttribute('href');
        if (hash) {
          history.pushState(null, '', hash);
          const target = document.getElementById(hash.slice(1));
          target?.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });

    // Mobile fade overlay - inject into frame (sibling to pre, outside scroll)
    if (window.innerWidth <= 640) {
      document.querySelectorAll('.expressive-code:not(.is-output-block) .frame').forEach((frame) => {
        if (frame.querySelector('.code-fade-overlay')) return;

        const overlay = document.createElement('div');
        overlay.className = 'code-fade-overlay';
        frame.appendChild(overlay);
      });
    }
  }

  // Run on initial load and page transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCodeBlocks);
  } else {
    initCodeBlocks();
  }
  document.addEventListener('astro:page-load', initCodeBlocks);

  // Re-check on resize for mobile overlay
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(initCodeBlocks, 100);
  });

  // Watch for React islands hydrating and adding new anchor links
  // This handles MethodHeader components that render after initial page load
  const anchorObserver = new MutationObserver((mutations) => {
    for (const mutation of mutations) {
      for (const node of mutation.addedNodes) {
        if (node.nodeType === Node.ELEMENT_NODE) {
          // Check if the added node is or contains an anchor link
          const anchors = node.classList?.contains('sl-anchor-link')
            ? [node]
            : node.querySelectorAll?.('.sl-anchor-link') || [];
          if (anchors.length > 0) {
            // Re-run init to set up the new anchor links
            initCodeBlocks();
            return; // Only need to run once per mutation batch
          }
        }
      }
    }
  });

  // Start observing once DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      anchorObserver.observe(document.body, { childList: true, subtree: true });
    });
  } else {
    anchorObserver.observe(document.body, { childList: true, subtree: true });
  }
</script>

<!-- Sidebar group navigation: click heading to expand and navigate to page -->
<script>
  function initSidebarNavigation() {
    // Normalize path by removing trailing slash for comparison
    const normalizePath = (path) => path.replace(/\/$/, '') || '/';

    // Strip API version from path for comparison (e.g., /api/v001-rc30/sprites -> /api/sprites)
    const stripApiVersion = (path) => path.replace(/^\/api\/[^/]+/, '/api');

    const currentPath = normalizePath(window.location.pathname);
    const currentPathNoVersion = stripApiVersion(currentPath);
    const currentHash = window.location.hash;

    // Find all nested sidebar groups within API Reference
    const sidebarGroups = document.querySelectorAll('nav[aria-label="Main"] details details');

    sidebarGroups.forEach((details) => {
      const summary = details.querySelector(':scope > summary');
      if (!summary) return;

      // Find the first link within this group to determine the page URL
      const firstLink = details.querySelector(':scope > ul a[href]');
      if (!firstLink) return;

      // Extract the page URL without the anchor and normalize
      const href = firstLink.getAttribute('href') || '';
      const pageUrl = normalizePath(href.split('#')[0]);
      const pageUrlNoVersion = stripApiVersion(pageUrl);
      if (!pageUrl) return;

      // Auto-expand if current page matches this group's page (comparing without version)
      if (currentPathNoVersion === pageUrlNoVersion) {
        details.setAttribute('open', '');
      }

      // Mark anchor links as current if they match the current URL hash
      const allLinks = details.querySelectorAll(':scope > ul a[href]');
      allLinks.forEach((link) => {
        const linkHref = link.getAttribute('href') || '';
        const linkPath = normalizePath(linkHref.split('#')[0]);
        const linkPathNoVersion = stripApiVersion(linkPath);
        const linkHash = linkHref.includes('#') ? '#' + linkHref.split('#')[1] : '';

        // Only mark as current if:
        // 1. Link has a hash and path matches (ignoring version) + hash matches exactly
        // 2. Link has no hash and we're on that exact page (ignoring version) with no hash
        const isCurrentLink = linkHash
          ? (linkPathNoVersion === currentPathNoVersion && linkHash === currentHash)
          : (linkPathNoVersion === currentPathNoVersion && !currentHash);

        if (isCurrentLink) {
          link.setAttribute('data-current', 'true');
        } else {
          link.removeAttribute('data-current');
        }
      });

      // Skip click handler setup if already initialized
      if (summary.dataset.navInit) return;
      summary.dataset.navInit = 'true';

      // Add click handler to summary
      summary.addEventListener('click', (e) => {
        // Allow normal toggle behavior with modifier keys
        if (e.shiftKey || e.ctrlKey || e.metaKey) return;

        // If currently closed and we're NOT already on this page, expand and navigate
        // (Compare without version to handle being on different version of same page)
        if (!details.open && currentPathNoVersion !== pageUrlNoVersion) {
          e.preventDefault();
          e.stopPropagation();
          // Navigate to the page (without anchor hash)
          window.location.href = pageUrl;
        }
        // If already on this page or already open, let default toggle behavior happen
      });

      // Make summary look clickable
      summary.style.cursor = 'pointer';
    });
  }

  // Run on initial load and page transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebarNavigation);
  } else {
    initSidebarNavigation();
  }
  document.addEventListener('astro:page-load', initSidebarNavigation);

  // Also update on hash change (when clicking anchor links)
  window.addEventListener('hashchange', initSidebarNavigation);
</script>
